generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── ENUMS ──────────────────────────────────────────────

enum UserRole {
  MINISTRY
  MP
  COMMITTEE_MEMBER
  SECRETARIAT
  SPEAKER
  PRESIDENT
  ADMIN
  PUBLIC
}

enum HouseType {
  HOR   // House of Representatives
  NA    // National Assembly
}

enum BillType {
  GOVERNMENT
  PRIVATE
  MONEY
  CONSTITUTIONAL_AMENDMENT
  ORDINANCE_REPLACEMENT
}

enum BillStatus {
  DRAFT
  LAW_MINISTRY_REVIEW
  CABINET_APPROVED
  REGISTERED
  FIRST_READING
  GENERAL_DISCUSSION
  AMENDMENT_WINDOW_OPEN
  COMMITTEE_REVIEW
  CLAUSE_VOTING
  FIRST_HOUSE_PASSED
  SECOND_HOUSE_PROCESSING
  JOINT_SITTING
  SPEAKER_CERTIFICATION
  PRESIDENTIAL_REVIEW
  ASSENTED
  GAZETTE_PUBLISHED
  IMPLEMENTATION_MONITORING
  LAPSED
  WITHDRAWN
  FAST_TRACK
}

enum VoteType {
  FOR
  AGAINST
  ABSTAIN
}

enum AmendmentStatus {
  PROPOSED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum DeadlineType {
  GOVERNMENT_BILL_NOTICE
  PRIVATE_BILL_NOTICE
  AMENDMENT_WINDOW
  NA_MONEY_BILL_RETURN
  NA_OTHER_BILL_RETURN
  PRESIDENTIAL_ASSENT
  PRESIDENTIAL_RETURN_WINDOW
}

enum PresidentialActionType {
  ASSENTED
  RETURNED
}

enum NotificationType {
  BILL_STATE_CHANGE
  DEADLINE_WARNING
  DEADLINE_EXPIRED
  VOTE_SCHEDULED
  COMMITTEE_ASSIGNMENT
  COMMENT_ADDED
  AMENDMENT_PROPOSED
  GENERAL
}

// ─── USERS & AUTH ───────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  nameNe        String?   // Nepali name
  passwordHash  String
  role          UserRole
  house         HouseType?
  party         String?
  constituency  String?
  isActive      Boolean   @default(true)
  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  billsAuthored       Bill[]              @relation("BillAuthor")
  billsSponsored      Bill[]              @relation("BillSponsor")
  amendments          Amendment[]
  comments            Comment[]
  votes               Vote[]
  committeeMemberships CommitteeMember[]
  eventLogs           EventLog[]          @relation("EventActor")
  notifications       Notification[]
  presidentialActions  PresidentialAction[]
  aiReports           AIReport[]

  @@index([role])
  @@index([house])
}

// ─── BILLS ──────────────────────────────────────────────

model Bill {
  id              String      @id @default(cuid())
  billNumber      String?     @unique
  title           String
  titleNe         String?     // Nepali title
  summary         String?     @db.Text
  billType        BillType
  status          BillStatus  @default(DRAFT)
  originHouse     HouseType
  currentHouse    HouseType?
  isFastTrack     Boolean     @default(false)
  isUrgent        Boolean     @default(false)

  // Relations
  authorId        String
  author          User        @relation("BillAuthor", fields: [authorId], references: [id])
  sponsorId       String?
  sponsor         User?       @relation("BillSponsor", fields: [sponsorId], references: [id])

  versions        BillVersion[]
  clauses         Clause[]
  amendments      Amendment[]
  comments        Comment[]
  transitions     BillTransition[]
  deadlines       Deadline[]
  voteSessions    VoteSession[]
  committeeAssignments CommitteeAssignment[]
  committeeReports     CommitteeReport[]
  presidentialActions  PresidentialAction[]
  gazettePublication   GazettePublication?
  aiReports            AIReport[]
  jointSittings        JointSitting[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([status])
  @@index([billType])
  @@index([originHouse])
}

model BillVersion {
  id          String   @id @default(cuid())
  billId      String
  bill        Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  version     Int
  content     String   @db.Text
  changeNote  String?
  createdById String?
  createdAt   DateTime @default(now())

  @@unique([billId, version])
  @@index([billId])
}

model Clause {
  id          String      @id @default(cuid())
  billId      String
  bill        Bill        @relation(fields: [billId], references: [id], onDelete: Cascade)
  number      Int
  title       String?
  content     String      @db.Text
  isAmended   Boolean     @default(false)
  version     Int         @default(1)

  amendments  Amendment[]
  comments    Comment[]

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([billId, number, version])
  @@index([billId])
}

// ─── AMENDMENTS ─────────────────────────────────────────

model Amendment {
  id              String          @id @default(cuid())
  billId          String
  bill            Bill            @relation(fields: [billId], references: [id], onDelete: Cascade)
  clauseId        String?
  clause          Clause?         @relation(fields: [clauseId], references: [id])
  proposedById    String
  proposedBy      User            @relation(fields: [proposedById], references: [id])
  originalText    String?         @db.Text
  proposedText    String          @db.Text
  justification   String?         @db.Text
  status          AmendmentStatus @default(PROPOSED)

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([billId])
  @@index([clauseId])
  @@index([status])
}

// ─── COMMENTS ───────────────────────────────────────────

model Comment {
  id          String   @id @default(cuid())
  billId      String
  bill        Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  clauseId    String?
  clause      Clause?  @relation(fields: [clauseId], references: [id])
  authorId    String
  author      User     @relation(fields: [authorId], references: [id])
  content     String   @db.Text
  parentId    String?
  parent      Comment? @relation("CommentReplies", fields: [parentId], references: [id])
  replies     Comment[] @relation("CommentReplies")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([billId])
  @@index([clauseId])
}

// ─── COMMITTEES ─────────────────────────────────────────

model Committee {
  id          String    @id @default(cuid())
  name        String
  nameNe      String?
  house       HouseType
  description String?   @db.Text
  quorum      Int       @default(3)
  isActive    Boolean   @default(true)
  isLegislationManagement Boolean @default(false) // special NA committee

  members     CommitteeMember[]
  assignments CommitteeAssignment[]
  reports     CommitteeReport[]
  hearings    CommitteeHearing[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([house])
}

model CommitteeMember {
  id          String    @id @default(cuid())
  committeeId String
  committee   Committee @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  isChair     Boolean   @default(false)
  joinedAt    DateTime  @default(now())
  leftAt      DateTime?

  @@unique([committeeId, userId])
  @@index([committeeId])
  @@index([userId])
}

model CommitteeAssignment {
  id          String    @id @default(cuid())
  committeeId String
  committee   Committee @relation(fields: [committeeId], references: [id])
  billId      String
  bill        Bill      @relation(fields: [billId], references: [id])
  assignedAt  DateTime  @default(now())
  dueDate     DateTime?
  isCompleted Boolean   @default(false)

  @@unique([committeeId, billId])
  @@index([billId])
}

model CommitteeReport {
  id              String    @id @default(cuid())
  committeeId     String
  committee       Committee @relation(fields: [committeeId], references: [id])
  billId          String
  bill            Bill      @relation(fields: [billId], references: [id])
  content         String    @db.Text
  recommendation  String?   @db.Text
  isApproved      Boolean   @default(false)
  approvedAt      DateTime?
  approvalVotes   Int?
  rejectionVotes  Int?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([billId])
  @@index([committeeId])
}

model CommitteeHearing {
  id          String    @id @default(cuid())
  committeeId String
  committee   Committee @relation(fields: [committeeId], references: [id])
  title       String
  date        DateTime
  notes       String?   @db.Text
  expertName  String?
  expertOrg   String?

  createdAt   DateTime  @default(now())
}

// ─── VOTING ─────────────────────────────────────────────

model VoteSession {
  id          String      @id @default(cuid())
  billId      String
  bill        Bill        @relation(fields: [billId], references: [id])
  house       HouseType
  title       String
  description String?
  quorumRequired Int
  isActive    Boolean     @default(true)
  isCompleted Boolean     @default(false)
  result      String?     // PASSED, REJECTED, NO_QUORUM
  totalFor    Int         @default(0)
  totalAgainst Int        @default(0)
  totalAbstain Int        @default(0)

  votes       Vote[]

  startedAt   DateTime    @default(now())
  completedAt DateTime?

  @@index([billId])
  @@index([house])
}

model Vote {
  id            String      @id @default(cuid())
  voteSessionId String
  voteSession   VoteSession @relation(fields: [voteSessionId], references: [id], onDelete: Cascade)
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  voteType      VoteType
  weight        Float       @default(1.0)  // for joint sitting weighted votes

  createdAt     DateTime    @default(now())

  @@unique([voteSessionId, userId])
  @@index([voteSessionId])
  @@index([userId])
}

model JointSitting {
  id          String   @id @default(cuid())
  billId      String
  bill        Bill     @relation(fields: [billId], references: [id])
  reason      String?  @db.Text
  scheduledAt DateTime
  heldAt      DateTime?
  result      String?
  notes       String?  @db.Text

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([billId])
}

// ─── WORKFLOW & DEADLINES ───────────────────────────────

model BillTransition {
  id          String      @id @default(cuid())
  billId      String
  bill        Bill        @relation(fields: [billId], references: [id], onDelete: Cascade)
  fromStatus  BillStatus
  toStatus    BillStatus
  triggeredBy String?     // user ID or "SYSTEM"
  reason      String?
  metadata    String?     @db.Text  // JSON

  createdAt   DateTime    @default(now())

  @@index([billId])
  @@index([createdAt])
}

model Deadline {
  id          String       @id @default(cuid())
  billId      String
  bill        Bill         @relation(fields: [billId], references: [id], onDelete: Cascade)
  type        DeadlineType
  startsAt    DateTime
  expiresAt   DateTime
  isExpired   Boolean      @default(false)
  isCompleted Boolean      @default(false)
  autoAction  String?      // action to take on expiry

  createdAt   DateTime     @default(now())

  @@index([billId])
  @@index([expiresAt])
  @@index([isExpired])
}

// ─── PRESIDENTIAL ───────────────────────────────────────

model PresidentialAction {
  id          String                @id @default(cuid())
  billId      String
  bill        Bill                  @relation(fields: [billId], references: [id])
  userId      String
  user        User                  @relation(fields: [userId], references: [id])
  action      PresidentialActionType
  remarks     String?               @db.Text
  returnCount Int                   @default(0)

  createdAt   DateTime              @default(now())

  @@index([billId])
}

// ─── GAZETTE & PUBLICATION ──────────────────────────────

model GazettePublication {
  id              String   @id @default(cuid())
  billId          String   @unique
  bill            Bill     @relation(fields: [billId], references: [id])
  gazetteNumber   String?
  publicationDate DateTime
  effectiveDate   DateTime?
  documentUrl     String?

  createdAt       DateTime @default(now())
}

// ─── AI & LEGAL INTELLIGENCE ────────────────────────────

model AIReport {
  id              String   @id @default(cuid())
  billId          String
  bill            Bill     @relation(fields: [billId], references: [id])
  generatedById   String?
  generatedBy     User?    @relation(fields: [generatedById], references: [id])
  reportType      String   // COMPLIANCE, CONFLICT, SUMMARY, RISK
  content         String   @db.Text
  riskLevel       String?  // LOW, MEDIUM, HIGH, CRITICAL
  citations       String?  @db.Text  // JSON array of citations
  modelUsed       String?

  createdAt       DateTime @default(now())

  @@index([billId])
  @@index([reportType])
}

model LegalReference {
  id          String   @id @default(cuid())
  title       String
  titleNe     String?
  category    String   // CONSTITUTION, ACT, REGULATION, RULE, RULING
  content     String   @db.Text
  section     String?
  articleNo   String?
  sourceUrl   String?
  embedding   String?  @db.Text  // stored as JSON array for now

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
}

// ─── AUDIT & NOTIFICATIONS ─────────────────────────────

model EventLog {
  id          String   @id @default(cuid())
  actorId     String?
  actor       User?    @relation("EventActor", fields: [actorId], references: [id])
  action      String
  entityType  String   // BILL, COMMITTEE, VOTE, etc.
  entityId    String
  details     String?  @db.Text  // JSON
  ipAddress   String?

  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([createdAt])
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id])
  type        NotificationType
  title       String
  message     String
  link        String?
  isRead      Boolean          @default(false)

  createdAt   DateTime         @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}
